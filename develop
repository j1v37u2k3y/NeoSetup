#!/usr/bin/env python3
"""
üé≠ NeoSetup Development Environment Setup
One-click development environment configuration with comprehensive validation
"""

import sys
import subprocess
from pathlib import Path

# Matrix-themed colors
GREEN = '\033[92m'
RED = '\033[91m'
BLUE = '\033[94m'
CYAN = '\033[96m'
YELLOW = '\033[93m'
BOLD = '\033[1m'
RESET = '\033[0m'

def print_matrix(message, color=GREEN):
    """Print Matrix-themed message"""
    print(f"{color}{BOLD}üé≠ {message}{RESET}")

def print_step(step_num, total_steps, message):
    """Print step progress"""
    print(f"{CYAN}{BOLD}Step {step_num}/{total_steps}:{RESET} {message}")

def run_command(command, cwd=None, check=True, capture_output=False):
    """Run command with error handling"""
    try:
        result = subprocess.run(
            command,
            shell=True,
            cwd=cwd,
            check=check,
            capture_output=capture_output,
            text=True
        )
        return result
    except subprocess.CalledProcessError as e:
        print(f"{RED}‚ùå Command failed: {command}{RESET}")
        if capture_output:
            print(f"{RED}Error: {e.stderr}{RESET}")
        return None

def check_requirements():
    """Check system requirements"""
    print_matrix("Checking system requirements...")

    # Check Python version
    if sys.version_info < (3, 8):
        print(f"{RED}‚ùå Python 3.8+ required. Current: {sys.version}{RESET}")
        return False

    # Check if we're in the right directory
    if not Path("neosetup").exists():
        print(f"{RED}‚ùå Must run from NeoSetup project root directory{RESET}")
        return False

    print(f"{GREEN}‚úÖ Python {sys.version_info.major}.{sys.version_info.minor} - OK{RESET}")
    print(f"{GREEN}‚úÖ Project directory - OK{RESET}")
    return True

def install_dependencies():
    """Install all Python dependencies"""
    print_step(1, 6, "Installing Python dependencies...")

    # Install runtime dependencies
    print("üì¶ Installing runtime dependencies...")
    if not run_command("pip3 install -r neosetup/requirements-runtime.txt"):
        return False

    # Install development dependencies
    print("üõ†Ô∏è Installing development dependencies...")
    if not run_command("pip3 install -r requirements.txt"):
        return False

    print(f"{GREEN}‚úÖ Python dependencies installed{RESET}")
    return True

def install_ansible_collections():
    """Install Ansible Galaxy collections"""
    print_step(2, 6, "Installing Ansible Galaxy collections...")

    if not run_command("ansible-galaxy install -r neosetup/requirements.yml --force"):
        return False

    print(f"{GREEN}‚úÖ Ansible collections installed{RESET}")
    return True

def setup_pre_commit():
    """Setup pre-commit hooks"""
    print_step(3, 6, "Setting up pre-commit hooks...")

    if not run_command("pre-commit install --install-hooks"):
        return False

    print(f"{GREEN}‚úÖ Pre-commit hooks installed{RESET}")
    return True

def run_validation_tests():
    """Run comprehensive validation tests"""
    print_step(4, 6, "Running validation tests...")

    print("üîç Testing Ansible syntax...")
    result = run_command("ansible-playbook playbooks/site.yml --syntax-check",
                        cwd="neosetup", check=False)
    if result and result.returncode == 0:
        print(f"{GREEN}‚úÖ Ansible syntax check passed{RESET}")
    else:
        print(f"{YELLOW}‚ö†Ô∏è Ansible syntax check issues (may be normal){RESET}")

    print("üß™ Testing operator validation...")
    for operator in ["base", "matrix", "jiveturkey"]:
        result = run_command(f"python3 scripts/validate_operator.py {operator}",
                           cwd="neosetup", check=False)
        if result and result.returncode == 0:
            print(f"{GREEN}‚úÖ Operator '{operator}' validation passed{RESET}")
        else:
            print(f"{YELLOW}‚ö†Ô∏è Operator '{operator}' validation issues{RESET}")

    print(f"{GREEN}‚úÖ Validation tests completed{RESET}")
    return True

def test_docker_files():
    """Test Docker container files with syntax validation"""
    print_step(5, 6, "Testing Docker container files...")

    # Scan docker/ directory for Dockerfiles
    docker_dir = Path("docker")
    if not docker_dir.exists():
        print(f"{YELLOW}‚ö†Ô∏è docker/ directory not found. Run from project root.{RESET}")
        return False

    dockerfiles = list(docker_dir.glob("Dockerfile.*"))
    if not dockerfiles:
        print(f"{YELLOW}‚ö†Ô∏è No Dockerfiles found in docker/ directory{RESET}")
        return False

    # Validate each Dockerfile with docker build --check (dry-run)
    passed = 0
    for dockerfile in sorted(dockerfiles):
        result = run_command(
            f"docker build --check -f {dockerfile} .",
            check=False,
            capture_output=True
        )
        if result and result.returncode == 0:
            print(f"  ‚úÖ {dockerfile.name}")
            passed += 1
        else:
            print(f"  ‚ùå {dockerfile.name} - syntax error")

    print(f"{GREEN}‚úÖ Validated {passed}/{len(dockerfiles)} Docker container files{RESET}")
    return passed == len(dockerfiles)

def run_pre_commit_test():
    """Run pre-commit on all files"""
    print_step(6, 6, "Running pre-commit validation...")

    print("ü™ù Running all pre-commit hooks...")
    result = run_command("pre-commit run --all-files", check=False)

    if result and result.returncode == 0:
        print(f"{GREEN}‚úÖ All pre-commit hooks passed{RESET}")
    else:
        print(f"{YELLOW}‚ö†Ô∏è Some pre-commit hooks found issues (auto-fixed where possible){RESET}")

    return True

def show_completion_info():
    """Show completion information and next steps"""
    print_matrix("Development environment setup complete! üéâ")
    print()
    print(f"{BOLD}üìã What was installed:{RESET}")
    print(f"  ‚úÖ Runtime dependencies (Ansible, PyYAML, etc.)")
    print(f"  ‚úÖ Development tools (ansible-lint, yamllint, pre-commit, etc.)")
    print(f"  ‚úÖ Ansible Galaxy collections (community.general, ansible.posix, etc.)")
    print(f"  ‚úÖ Pre-commit hooks (automatic validation on git commit)")
    print()
    print(f"{BOLD}üöÄ Quick commands to try:{RESET}")
    print(f"  {CYAN}cd neosetup && make dry-run OPERATOR=matrix{RESET}     # Preview installation")
    print(f"  {CYAN}cd neosetup && make install OPERATOR=base{RESET}      # Install base operator")
    print(f"  {CYAN}pre-commit run --all-files{RESET}                     # Run all validation")
    print(f"  {CYAN}cd neosetup && make lint{RESET}                       # Run ansible-lint")
    print()
    print(f"{BOLD}üê≥ Docker testing:{RESET}")
    print(f"  {CYAN}docker build -f docker/Dockerfile.ubuntu-22.04 -t test-ubuntu .{RESET}")
    print(f"  {CYAN}docker build -f docker/Dockerfile.rocky-9 -t test-rocky .{RESET}")
    print()
    print_matrix("Ready to hack the Matrix! üíä")

def main():
    """Main development setup function"""
    print_matrix("Welcome to NeoSetup Development Environment Setup")
    print(f"{BLUE}This will set up everything needed for NeoSetup development.{RESET}")
    print()

    # Check requirements
    if not check_requirements():
        sys.exit(1)

    # Run setup steps
    steps = [
        install_dependencies,
        install_ansible_collections,
        setup_pre_commit,
        run_validation_tests,
        test_docker_files,
        run_pre_commit_test
    ]

    for step_func in steps:
        if not step_func():
            print(f"{RED}‚ùå Setup failed at step: {step_func.__name__}{RESET}")
            sys.exit(1)
        print()  # Add spacing between steps

    # Show completion info
    show_completion_info()

if __name__ == "__main__":
    main()
