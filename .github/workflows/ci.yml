---
name: ðŸš€ NeoSetup CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly security scans
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      run_full_tests:
        description: 'Run full test suite including integration tests'
        required: false
        default: 'false'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  MATRIX_MODE: enabled

jobs:
  # ============================================================================
  # PRE-COMMIT - All linting and validation in one job
  # ============================================================================

  pre-commit:
    name: ðŸ” Pre-commit Checks
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: pip install -r requirements.txt

      - name: ðŸ” Run all pre-commit hooks
        run: |
          echo "ðŸ” Running all pre-commit hooks..."
          pre-commit run --all-files

  # ============================================================================
  # SECURITY SCANNING (not covered by pre-commit)
  # ============================================================================

  security-scan:
    name: ðŸ›¡ï¸ Security Scanning
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Run CodeQL Analysis (Init)
        uses: github/codeql-action/init@v3
        with:
          languages: python
        continue-on-error: true

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        continue-on-error: true

      - name: ðŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: ðŸ“¤ Generate SARIF for GitHub Security
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        if: always()

      - name: ðŸ“¤ Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  # ============================================================================
  # ANSIBLE MULTI-VERSION TESTING (not covered by pre-commit)
  # ============================================================================

  ansible-syntax:
    name: ðŸŽ­ Ansible Syntax Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ansible-version: ['6.0', '7.0']
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install Ansible ${{ matrix.ansible-version }}
        run: |
          if [ "${{ matrix.ansible-version }}" = "6.0" ]; then
            pip install "ansible>=6.0,<7.0"
          elif [ "${{ matrix.ansible-version }}" = "7.0" ]; then
            pip install "ansible>=7.0,<8.0"
          fi

      - name: âœ… Ansible syntax check
        run: |
          cd neosetup
          ansible-playbook playbooks/site.yml --syntax-check
          find playbooks -name "*.yml" | while read -r playbook; do
            echo "Checking syntax: $playbook"
            ansible-playbook "$playbook" --syntax-check
          done

  # ============================================================================
  # DOCUMENTATION VALIDATION (not covered by pre-commit)
  # ============================================================================

  docs-validation:
    name: ðŸ“š Documentation Validation
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“š Check documentation completeness
        run: |
          echo "ðŸ“š Checking documentation completeness..."

          for operator in neosetup/operators/*/; do
            operator_name=$(basename "$operator")
            if [ ! -f "$operator/README.md" ] && [ ! -f "$operator/vars.yml" ]; then
              echo "âŒ Missing documentation for operator: $operator_name"
              exit 1
            fi
          done

          for role in neosetup/roles/*/; do
            role_name=$(basename "$role")
            if [ ! -f "$role/README.md" ] && [ ! -f "$role/meta/main.yml" ]; then
              echo "âš ï¸ Missing documentation for role: $role_name"
            fi
          done

          echo "âœ… Documentation completeness check passed"

      - name: ðŸ“¦ Install link checker
        run: npm install -g markdown-link-check

      - name: ðŸ”— Check markdown links
        run: |
          echo "ðŸ”— Checking markdown links..."
          find . -name "*.md" -not -path "./.git/*" | while read -r file; do
            echo "Checking links in: $file"
            markdown-link-check "$file" --config .github/markdown-link-check.json
          done

  # ============================================================================
  # SUMMARY & REPORTING
  # ============================================================================

  test-summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [pre-commit, security-scan, ansible-syntax, docs-validation]
    if: always()
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“Š Generate test summary
        env:
          PRE_COMMIT_RESULT: ${{ needs.pre-commit.result }}
          SECURITY_SCAN_RESULT: ${{ needs.security-scan.result }}
          ANSIBLE_SYNTAX_RESULT: ${{ needs.ansible-syntax.result }}
          DOCS_VALIDATION_RESULT: ${{ needs.docs-validation.result }}
        run: python3 .github/scripts/generate_test_summary.py

      - name: âŒ Fail if critical jobs failed
        if: ${{ needs.pre-commit.result != 'success' || needs.ansible-syntax.result != 'success' }}
        run: |
          echo "âŒ Critical jobs failed!"
          echo "  pre-commit: ${{ needs.pre-commit.result }}"
          echo "  ansible-syntax: ${{ needs.ansible-syntax.result }}"
          exit 1

      - name: ðŸŽ‰ Success notification
        if: ${{ needs.pre-commit.result == 'success' && needs.ansible-syntax.result == 'success' }}
        run: echo "ðŸŽ‰ All critical tests passed! NeoSetup is ready to rock! ðŸš€"
