name: ğŸ³ Container Multi-OS Testing

on:
  workflow_run:
    workflows: ["ğŸš€ NeoSetup CI/CD Pipeline"]
    types:
      - completed
    # No branch filter - run container tests for any successful CI/CD completion
  schedule:
    # Run nightly
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      test_all_operators:
        description: 'Test all operators on all OS'
        required: false
        default: 'false'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ANSIBLE_VERSION: '>=4.0'

jobs:
  # ============================================================================
  # BUILD TEST CONTAINERS
  # ============================================================================

  build-test-containers:
    name: ğŸ”¨ Build Test Containers
    runs-on: ubuntu-latest
    # Run on successful CI/CD (any branch), manual dispatch, or schedule
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule'
    strategy:
      fail-fast: false
      matrix:
        os:
          # Debian-based
          - { name: 'ubuntu-22.04', dockerfile: 'Dockerfile.ubuntu-22.04' }
          - { name: 'ubuntu-24.04', dockerfile: 'Dockerfile.ubuntu-24.04' }
          - { name: 'debian-12', dockerfile: 'Dockerfile.debian-12' }
          - { name: 'kali-rolling', dockerfile: 'Dockerfile.kali-rolling' }
          - { name: 'parrot-security', dockerfile: 'Dockerfile.parrot-security' }
          # RHEL-based
          - { name: 'centos-stream-9', dockerfile: 'Dockerfile.centos-stream-9' }
          - { name: 'rocky-9', dockerfile: 'Dockerfile.rocky-9' }
          - { name: 'almalinux-9', dockerfile: 'Dockerfile.almalinux-9' }
          - { name: 'fedora-40', dockerfile: 'Dockerfile.fedora-40' }
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§¹ Free disk space
        run: |
          # Remove unnecessary large packages to free disk space for container builds
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build test container for ${{ matrix.os.name }}
        run: |
          docker build -f docker/${{ matrix.os.dockerfile }} -t neosetup-test-${{ matrix.os.name }} .

      - name: ğŸ“¦ Export container
        run: |
          docker save neosetup-test-${{ matrix.os.name }} | gzip > neosetup-test-${{ matrix.os.name }}.tar.gz

      - name: ğŸ“¤ Upload container artifact
        uses: actions/upload-artifact@v6
        with:
          name: test-container-${{ matrix.os.name }}
          path: neosetup-test-${{ matrix.os.name }}.tar.gz
          retention-days: 1

  # ============================================================================
  # MULTI-OS OPERATOR TESTING
  # ============================================================================

  test-operators-multi-os:
    name: ğŸ§ª Test ${{ matrix.operator }} on ${{ matrix.os.name }}
    runs-on: ubuntu-latest
    needs: build-test-containers
    strategy:
      fail-fast: false
      matrix:
        os:
          # Debian-based
          - { name: 'ubuntu-22.04', pkg_mgr: 'apt' }
          - { name: 'ubuntu-24.04', pkg_mgr: 'apt' }
          - { name: 'debian-12', pkg_mgr: 'apt' }
          - { name: 'kali-rolling', pkg_mgr: 'apt' }
          - { name: 'parrot-security', pkg_mgr: 'apt' }
          # RHEL-based
          - { name: 'centos-stream-9', pkg_mgr: 'dnf' }
          - { name: 'rocky-9', pkg_mgr: 'dnf' }
          - { name: 'almalinux-9', pkg_mgr: 'dnf' }
          - { name: 'fedora-40', pkg_mgr: 'dnf' }
        operator: [base, matrix, jiveturkey]
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download test container
        uses: actions/download-artifact@v7
        with:
          name: test-container-${{ matrix.os.name }}

      - name: ğŸ³ Load test container
        run: |
          docker load < neosetup-test-${{ matrix.os.name }}.tar.gz

      - name: ğŸ§ª Run operator test in container
        run: |
          # Create test inventory
          mkdir -p test-inventory
          echo "localhost ansible_connection=local ansible_python_interpreter=/usr/bin/python3" > test-inventory/hosts

          # Run comprehensive test using Python script
          docker run --rm \
            -v $(pwd):/neosetup \
            -w /neosetup \
            neosetup-test-${{ matrix.os.name }} \
            python3 .github/scripts/test_container.py \
              --os "${{ matrix.os.name }}" \
              --operator "${{ matrix.operator }}"

      - name: ğŸ§ª Test package installation compatibility
        run: |
          docker run --rm \
            -v $(pwd):/neosetup \
            -w /neosetup \
            neosetup-test-${{ matrix.os.name }} \
            python3 .github/scripts/test_packages.py \
              --os "${{ matrix.os.name }}" \
              --pkg-mgr "${{ matrix.os.pkg_mgr }}"

      # NOTE: Binary validation (test_binary_validation.py) is available for local testing
      # but not included in CI since container tests use dry-run mode and don't install tools.
      # Run locally with: python3 .github/scripts/test_binary_validation.py --os darwin --operator base -v

  # ============================================================================
  # PERFORMANCE TESTING ACROSS OS
  # ============================================================================

  performance-test-multi-os:
    name: âš¡ Performance Test on ${{ matrix.os.name }}
    runs-on: ubuntu-latest
    needs: build-test-containers
    if: github.event.inputs.test_all_operators == 'true' || github.event_name == 'schedule'
    strategy:
      fail-fast: false
      matrix:
        os:
          # Debian-based
          - { name: 'ubuntu-22.04' }
          - { name: 'ubuntu-24.04' }
          - { name: 'debian-12' }
          - { name: 'kali-rolling' }
          - { name: 'parrot-security' }
          # RHEL-based
          - { name: 'centos-stream-9' }
          - { name: 'rocky-9' }
          - { name: 'almalinux-9' }
          - { name: 'fedora-40' }
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download test container
        uses: actions/download-artifact@v7
        with:
          name: test-container-${{ matrix.os.name }}

      - name: ğŸ³ Load test container
        run: |
          docker load < neosetup-test-${{ matrix.os.name }}.tar.gz

      - name: âš¡ Run performance benchmark
        run: |
          mkdir -p test-inventory
          echo "localhost ansible_connection=local ansible_python_interpreter=/usr/bin/python3" > test-inventory/hosts

          docker run --rm \
            -v $(pwd):/neosetup \
            -w /neosetup \
            neosetup-test-${{ matrix.os.name }} \
            python3 .github/scripts/test_performance.py \
              --os "${{ matrix.os.name }}" \
              --target 300

  # ============================================================================
  # INTEGRATION TEST WITH ACTUAL INSTALLATION
  # ============================================================================

  integration-test:
    name: ğŸ”§ Integration Test on Ubuntu
    runs-on: ubuntu-latest
    needs: build-test-containers
    if: github.event.inputs.test_all_operators == 'true'
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download test container
        uses: actions/download-artifact@v7
        with:
          name: test-container-ubuntu-22.04

      - name: ğŸ³ Load test container
        run: |
          docker load < neosetup-test-ubuntu-22.04.tar.gz

      - name: ğŸ”§ Run full integration test
        run: |
          mkdir -p test-inventory
          echo "localhost ansible_connection=local ansible_python_interpreter=/usr/bin/python3" > test-inventory/hosts

          docker run --rm \
            -v $(pwd):/neosetup \
            -w /neosetup/neosetup \
            neosetup-test-ubuntu-22.04 \
            bash -c "
              echo 'ğŸ”§ Full integration test starting...'

              # Activate virtual environment
              source /opt/ansible-venv/bin/activate
              export PATH=/opt/ansible-venv/bin:\$PATH

              # Run limited actual installation (safe operations only)
              ansible-playbook playbooks/site.yml \
                -i ../test-inventory/hosts \
                -e 'operator=base' \
                -e 'integration_test=true' \
                --tags 'validation,shell_config,tmux_config' \
                -v

              # Verify some basic functionality
              if [ -f ~/.bashrc ]; then
                echo 'âœ… Shell configuration files created'
              fi

              echo 'ğŸ‰ Integration test completed!'
            "

  # ============================================================================
  # TEST SUMMARY
  # ============================================================================

  docker-test-summary:
    name: ğŸ“Š Docker Test Summary
    runs-on: ubuntu-latest
    needs: [ test-operators-multi-os, performance-test-multi-os ]
    if: always()
    steps:
      - name: ğŸ“Š Generate summary
        run: |
          echo "# ğŸ³ Docker Multi-OS Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results by OS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-operators-multi-os.result }}" = "success" ]; then
            echo "âœ… **Multi-OS Operator Tests**: All platforms passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Multi-OS Operator Tests**: Some platforms failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.performance-test-multi-os.result }}" = "success" ]; then
            echo "âš¡ **Performance Tests**: All platforms within target" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.performance-test-multi-os.result }}" = "skipped" ]; then
            echo "â­ï¸ **Performance Tests**: Skipped (manual trigger required)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Performance Tests**: Some platforms exceeded target" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tested Platforms" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Distribution | Package Manager |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu 22.04 | apt |" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu 24.04 | apt |" >> $GITHUB_STEP_SUMMARY
          echo "| Debian 12 | apt |" >> $GITHUB_STEP_SUMMARY
          echo "| Kali Linux | apt |" >> $GITHUB_STEP_SUMMARY
          echo "| Parrot Security | apt |" >> $GITHUB_STEP_SUMMARY
          echo "| CentOS Stream 9 | dnf |" >> $GITHUB_STEP_SUMMARY
          echo "| Rocky Linux 9 | dnf |" >> $GITHUB_STEP_SUMMARY
          echo "| AlmaLinux 9 | dnf |" >> $GITHUB_STEP_SUMMARY
          echo "| Fedora 40 | dnf |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¯ **Operators Tested**: base, matrix, jiveturkey" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š **Total Test Combinations**: 27 (9 distros Ã— 3 operators)" >> $GITHUB_STEP_SUMMARY
