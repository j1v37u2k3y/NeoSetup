{% set shell_type = 'zsh' %}
{% include 'shared/header.j2' %}

{% include 'shared/matrix_greeting.j2' %}

{% include 'shared/path.j2' %}

# ============================================================================
# Oh My Zsh Configuration
# ============================================================================
export ZSH="$HOME/.oh-my-zsh"

# Theme configuration
ZSH_THEME="{{ shell_config.oh_my_zsh_theme | default('powerlevel10k/powerlevel10k') }}"

# Plugin configuration
plugins=(
git
zsh-autosuggestions
zsh-syntax-highlighting
docker
kubectl
history-substring-search
{% for plugin in shell_config.oh_my_zsh_plugins | default([]) %}
  {% if plugin not in ['git', 'zsh-autosuggestions', 'zsh-syntax-highlighting', 'docker', 'kubectl', 'history-substring-search'] %}
    {{ plugin }}
  {% endif %}
{% endfor %}
)

# Oh My Zsh settings
CASE_SENSITIVE="{{ shell_config.case_sensitive | default('false') }}"
HYPHEN_INSENSITIVE="{{ shell_config.hyphen_insensitive | default('true') }}"
DISABLE_AUTO_UPDATE="{{ shell_config.disable_auto_update | default('false') }}"
ENABLE_CORRECTION="{{ shell_config.enable_correction | default('false') }}"
COMPLETION_WAITING_DOTS="{{ shell_config.completion_waiting_dots | default('true') }}"
HIST_STAMPS="{{ shell_config.hist_stamps | default('yyyy-mm-dd') }}"

# Oh My Zsh initialization
source $ZSH/oh-my-zsh.sh

{% include 'shared/environment.j2' %}

{% include 'shared/aliases.j2' %}

{% include 'shared/functions.j2' %}

# ============================================================================
# Zsh-specific Settings
# ============================================================================
# History settings
setopt EXTENDED_HISTORY
setopt HIST_EXPIRE_DUPS_FIRST
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_VERIFY
setopt INC_APPEND_HISTORY
setopt SHARE_HISTORY

# Directory navigation
setopt AUTO_CD
setopt AUTO_PUSHD
setopt PUSHD_IGNORE_DUPS
setopt PUSHDMINUS

# Completion
setopt COMPLETE_IN_WORD
setopt ALWAYS_TO_END
setopt PATH_DIRS
setopt AUTO_MENU
setopt AUTO_LIST
setopt AUTO_PARAM_SLASH
setopt EXTENDED_GLOB
unsetopt MENU_COMPLETE
unsetopt FLOW_CONTROL

# ============================================================================
# Key Bindings
# ============================================================================
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down
bindkey '^P' history-substring-search-up
bindkey '^N' history-substring-search-down

# ============================================================================
# Powerlevel10k Configuration
# ============================================================================
{% if shell_config.oh_my_zsh_theme == 'powerlevel10k/powerlevel10k' %}
  # To customize prompt, run `p10k configure` or edit ~/.p10k.zsh
  [[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

  # Enable Powerlevel10k instant prompt
  if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
  fi
{% endif %}

# ============================================================================
# Custom Configuration
# ============================================================================
{% if shell_config.custom_zsh is defined %}
  {{ shell_config.custom_zsh }}
{% endif %}

# Source local configuration if it exists
[[ -f ~/.zshrc.local ]] && source ~/.zshrc.local

# ============================================================================
# Matrix Effect on Start
# ============================================================================
{% if neosetup_operator in ['matrix', 'jiveturkey'] and shell_config.matrix_on_start | default(false) %}
  # Show Matrix effect on terminal start (can be disabled in ~/.zshrc.local)
  if [[ -z "$MATRIX_EFFECT_SHOWN" ]] && command -v cmatrix &>/dev/null; then
  export MATRIX_EFFECT_SHOWN=1
  timeout 3 cmatrix -b 2>/dev/null || true
  fi
{% endif %}
