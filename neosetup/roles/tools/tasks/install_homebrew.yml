---
# Install Homebrew on macOS
# This task ensures Homebrew is properly installed and configured

- name: "ğŸ Check if Homebrew is already installed"
  stat:
    path: "{{ homebrew_prefix }}/bin/brew"
  register: homebrew_installed

- name: "ğŸ“‹ Display Homebrew installation info"
  debug:
    msg: |
      ğŸ Homebrew Installation Status
      ğŸ“ Expected location: {{ homebrew_prefix }}
      âœ… Already installed: {{ homebrew_installed.stat.exists }}
      ğŸ”§ Architecture: {{ ansible_architecture }}

- name: "ğŸ Install Homebrew"
  when: not homebrew_installed.stat.exists
  block:
    - name: "ğŸ“¥ Download and install Homebrew"
      shell: |
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      register: homebrew_install
      failed_when: homebrew_install.rc != 0
      changed_when: true

    - name: "ğŸ” Verify Homebrew installation"
      stat:
        path: "{{ homebrew_prefix }}/bin/brew"
      register: homebrew_verify

    - name: "âŒ Homebrew installation failed"
      fail:
        msg: |
          ğŸ Homebrew installation failed!
          ğŸ“ Expected at: {{ homebrew_prefix }}/bin/brew
          ğŸ’¡ Manual installation: https://brew.sh
      when: not homebrew_verify.stat.exists

- name: "ğŸ”§ Update Homebrew and taps"
  homebrew:
    update_homebrew: yes
  register: homebrew_update
  failed_when: false

- name: "ğŸ“‹ Essential Homebrew taps"
  homebrew_tap:
    name: "{{ item }}"
    state: present
  loop:
    - homebrew/core
    - homebrew/cask
    - homebrew/cask-fonts
  failed_when: false

- name: "ğŸ Configure Homebrew environment"
  blockinfile:
    path: "{{ ansible_user_dir }}/.zprofile"
    create: yes
    marker: "# {mark} HOMEBREW ENVIRONMENT"
    block: |
      # Homebrew environment setup
      if [[ -d "{{ homebrew_prefix }}" ]]; then
        export HOMEBREW_PREFIX="{{ homebrew_prefix }}"
        export HOMEBREW_CELLAR="{{ homebrew_prefix }}/Cellar"
        export HOMEBREW_REPOSITORY="{{ homebrew_prefix }}"
        export PATH="{{ homebrew_prefix }}/bin:{{ homebrew_prefix }}/sbin:$PATH"
        export MANPATH="{{ homebrew_prefix }}/share/man:$MANPATH"
        export INFOPATH="{{ homebrew_prefix }}/share/info:$INFOPATH"
      fi

- name: "ğŸ Configure Homebrew for bash"
  blockinfile:
    path: "{{ ansible_user_dir }}/.bash_profile"
    create: yes
    marker: "# {mark} HOMEBREW ENVIRONMENT"
    block: |
      # Homebrew environment setup
      if [[ -d "{{ homebrew_prefix }}" ]]; then
        export HOMEBREW_PREFIX="{{ homebrew_prefix }}"
        export HOMEBREW_CELLAR="{{ homebrew_prefix }}/Cellar"
        export HOMEBREW_REPOSITORY="{{ homebrew_prefix }}"
        export PATH="{{ homebrew_prefix }}/bin:{{ homebrew_prefix }}/sbin:$PATH"
        export MANPATH="{{ homebrew_prefix }}/share/man:$MANPATH"
        export INFOPATH="{{ homebrew_prefix }}/share/info:$INFOPATH"
      fi

- name: "âœ… Homebrew setup complete"
  debug:
    msg: |
      ğŸ Homebrew is ready!
      ğŸ“ Location: {{ homebrew_prefix }}
      ğŸ”§ Run 'brew --version' to verify
      ğŸ’¡ Essential taps: core, cask, cask-fonts
