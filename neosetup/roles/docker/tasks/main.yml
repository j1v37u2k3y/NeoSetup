---
# Docker Role - Install and configure Docker
# The containers have you, Neo

- name: "ğŸ” Check if Docker is already installed"
  command: which docker
  register: docker_check
  failed_when: false
  changed_when: false

- name: "ğŸ“‹ Display Docker installation status"
  debug:
    msg: |
      ğŸ³ Docker Status: {{ 'Already installed' if docker_check.rc == 0 else 'Not found - will install' }}
      ğŸ’» OS Family: {{ ansible_os_family }}
      ğŸ“¦ Distribution: {{ ansible_distribution | default('Unknown') }}

- name: "ğŸ³ Install Docker on macOS"
  block:
    - name: "ğŸº Check if Homebrew is available"
      command: which brew
      register: brew_check
      failed_when: false
      changed_when: false

    - name: "ğŸ³ Install Docker via Homebrew"
      homebrew_cask:
        name: docker
        state: present
      when: brew_check.rc == 0

    - name: "ğŸ“‹ Manual installation notice"
      debug:
        msg: |
          ğŸ³ If Homebrew installation failed, please install Docker Desktop manually:
          ğŸ“¥ Download from: https://docker.com/products/docker-desktop
      when: brew_check.rc != 0

  when:
    - ansible_os_family == "Darwin"
    - docker_check.rc != 0

- name: "ğŸ³ Install Docker on Kali Linux"
  block:
    - name: "ğŸ“¦ Install Docker from Kali repositories"
      package:
        name:
          - docker.io
          - docker-compose
        state: present
      become: yes

  when:
    - ansible_distribution == "Kali"
    - docker_check.rc != 0

- name: "ğŸ³ Install Docker on Debian/Ubuntu"
  block:
    - name: "ğŸ“¦ Install Docker dependencies"
      package:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
      become: yes

    - name: "ğŸ”‘ Create keyrings directory"
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      become: yes

    - name: "ğŸ”‘ Add Docker GPG key"
      get_url:
        url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg"
        dest: /etc/apt/keyrings/docker.gpg
        mode: '0644'
      become: yes

    - name: "ğŸ“ Add Docker repository"
      vars:
        docker_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else ansible_architecture }}"
        docker_url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}"
      apt_repository:
        repo: "deb [arch={{ docker_arch }} signed-by=/etc/apt/keyrings/docker.gpg] {{ docker_url }} {{ ansible_distribution_release }} stable"
        state: present
        filename: docker
      become: yes

    - name: "ğŸ”„ Update package cache"
      apt:
        update_cache: yes
      become: yes

    - name: "ğŸ³ Install Docker packages"
      package:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
      become: yes

  when:
    - ansible_os_family == "Debian"
    - ansible_distribution != "Kali"
    - docker_check.rc != 0

- name: "ğŸ³ Install Docker on RHEL/CentOS/Fedora"
  block:
    - name: "ğŸ“¦ Install Docker dependencies"
      package:
        name:
          - yum-utils
          - device-mapper-persistent-data
          - lvm2
        state: present
      become: yes

    - name: "ğŸ“ Add Docker repository"
      yum_repository:
        name: docker-ce-stable
        description: Docker CE Stable
        baseurl: "https://download.docker.com/linux/{{ 'centos' if ansible_distribution == 'CentOS' else ansible_distribution | lower }}/$releasever/$basearch/stable"
        gpgcheck: yes
        gpgkey: "https://download.docker.com/linux/{{ 'centos' if ansible_distribution == 'CentOS' else ansible_distribution | lower }}/gpg"
        enabled: yes
      become: yes

    - name: "ğŸ³ Install Docker packages"
      package:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
      become: yes

  when:
    - ansible_os_family == "RedHat"
    - docker_check.rc != 0

- name: "ğŸ³ Install Docker on Arch Linux"
  block:
    - name: "ğŸ³ Install Docker packages"
      package:
        name:
          - docker
          - docker-compose-plugin
        state: present
      become: yes

  when:
    - ansible_distribution == "Archlinux"
    - docker_check.rc != 0

- name: "ğŸ” Check if docker group exists"
  command: getent group docker
  register: docker_group_check
  failed_when: false
  changed_when: false

- name: "ğŸ‘¥ Create docker group if it doesn't exist"
  group:
    name: docker
    state: present
  become: yes
  when:
    - docker_group_check.rc != 0
    - ansible_os_family != "Darwin"

- name: "ğŸ‘¥ Add user to docker group"
  user:
    name: "{{ ansible_user_id }}"
    groups: docker
    append: yes
  become: yes
  when:
    - neosetup_add_user_to_docker | default(true)
    - ansible_os_family != "Darwin"

- name: "ğŸš€ Start and enable Docker service (Kali)"
  systemd:
    name: docker.io
    state: started
    enabled: yes
  become: yes
  when:
    - ansible_distribution == "Kali"
  register: docker_service_result_kali

- name: "ğŸš€ Start and enable Docker service (Other Linux)"
  systemd:
    name: docker
    state: started
    enabled: yes
  become: yes
  when:
    - ansible_os_family != "Darwin"
    - ansible_distribution != "Kali"
  register: docker_service_result_other

- name: "ğŸ” Verify Docker installation"
  command: docker --version
  register: docker_version
  changed_when: false
  failed_when: false

- name: "ğŸ§ª Test Docker with hello-world (if service is running)"
  command: docker run --rm hello-world
  register: docker_test
  failed_when: false
  changed_when: false
  when:
    - docker_version is defined and docker_version.stdout is defined
    - ansible_os_family != "Darwin"

- name: "ğŸ”§ Configure Docker with modern features"
  include_tasks: configure_docker.yml
  when: docker_check.rc == 0 or docker_version.rc == 0

- name: "âœ… Docker installation complete"
  debug:
    msg: |
      ğŸ³ Docker Installation Summary:
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ“¦ Version: {{ docker_version.stdout | default('Check manually') }}
      ğŸ”§ Service Status: {{ 'Started' if ansible_os_family != 'Darwin' else 'Manual start required (macOS)' }}
      ğŸ‘¥ User Groups: {{ 'Added to docker group' if ansible_os_family != 'Darwin' else 'Not applicable (macOS)' }}
      ğŸ—ï¸ BuildKit: {{ 'Enabled' if docker_buildkit.enabled | default(true) else 'Disabled' }}
      ğŸ“¦ Compose v2: {{ 'Installed' if docker_install_compose | default(true) else 'Not installed' }}
      ğŸ”’ Security: {{ 'Enhanced' if docker_security is defined else 'Default' }}
      ğŸ§ª Test Result: {{ 'Skipped on macOS' if ansible_os_family == 'Darwin' else 'Check with: docker run hello-world' }}

      ğŸ’¡ Next steps:
      {% if ansible_os_family == "Darwin" %}
      - Start Docker Desktop application
      {% else %}
      - Log out and back in for group changes to take effect
      {% endif %}
      - Test with: docker run hello-world
      - Use 'docker compose' (v2) instead of 'docker-compose'
      - BuildKit is enabled for faster builds
